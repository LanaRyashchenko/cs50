def register():
    """Register user."""
    session.clear()

    # if user reached route via POST (as by submitting a form via POST)
    if request.method == "POST":

        # ensure username was submitted
        if not request.form.get("username"):
            return apology("must provide username")

        # ensure password was submitted
        elif not request.form.get("password"):
            return apology("must provide password")
            
        if request.form.get("password") != request.form.get("password_confirm"):
            return apology("password mismatch")
        
        rows = db.execute("SELECT * FROM users WHERE username = :username", username=request.form.get("username"))
        if len(rows) != 0:
            return apology("Sorry, this user already exists")
     
        hash = pwd_context.encrypt(request.form.get("password"))
        
        result = db.execute("INSERT INTO users (username, hash) VALUES (:username, :hash)", username = request.form.get("username"), hash = hash)

        if not result:
            return apology("Sorry, this user already exists")
        else:
            session["user_id"] = rows[0]["id"]
            return redirect(url_for("index"))
    else:
        return render_template("register.html")

